# =============================================================================
# SochDB Unified Release Pipeline - Azure DevOps
# =============================================================================
#
# Single pipeline that releases all SDK packages atomically:
#   - crates.io: sochdb (Rust)
#   - PyPI: sochdb-client (Python)
#   - npm: @sochdb/sochdb (JavaScript)
#   - Go modules: github.com/sochdb/sochdb-go (Go)
#
# Principle: When version changes, it changes everywhere.
#
# Required Variable Groups:
#   - sochdb-release-secrets
#     - CRATES_IO_TOKEN
#     - PYPI_API_TOKEN
#     - NPM_TOKEN
# =============================================================================

trigger: none  # Manual trigger only

parameters:
  - name: version
    displayName: 'Release version (e.g., 0.2.3)'
    type: string
  - name: dryRun
    displayName: 'Dry run (validate without publishing)'
    type: boolean
    default: false
  - name: targets
    displayName: 'What to release'
    type: string
    default: 'all'
    values:
      - all
      - rust
      - python
      - npm
      - go

variables:
  - group: sochdb-release-secrets
  - name: CARGO_TERM_COLOR
    value: 'always'
  - name: RUST_BACKTRACE
    value: '1'

stages:
  # ===========================================================================
  # Stage 1: Validate
  # ===========================================================================
  - stage: Validate
    displayName: 'Validate'
    jobs:
      - job: ValidateAll
        displayName: 'Run tests and checks'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '3.12'
            displayName: 'Set up Python'

          - script: |
              curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
              echo "##vso[task.prependpath]$HOME/.cargo/bin"
            displayName: 'Install Rust'

          - script: |
              rustup component add rustfmt clippy
            displayName: 'Install Rust components'

          - script: cargo fmt --all -- --check
            displayName: 'Check Rust formatting'

          - script: cargo clippy --all-targets -- -D warnings
            displayName: 'Run clippy'

          - script: cargo test --release --workspace
            displayName: 'Run Rust tests'

          - script: |
              cd sochdb-python-sdk
              pip install build twine
              python -m build --sdist
              twine check dist/*
            displayName: 'Validate Python package'

          - task: NodeTool@0
            inputs:
              versionSpec: '20.x'
            displayName: 'Set up Node.js'

          - script: |
              cd sochdb-js
              npm ci
              npm run build
              npm test
            displayName: 'Validate JavaScript package'

          - task: GoTool@0
            inputs:
              version: '1.22'
            displayName: 'Set up Go'

          - script: |
              cd sochdb-go
              go mod download
              go build -v ./...
              go test -v ./...
            displayName: 'Validate Go package'

  # ===========================================================================
  # Stage 2: Publish Rust to crates.io
  # ===========================================================================
  - stage: PublishRust
    displayName: 'Publish to crates.io'
    dependsOn: Validate
    condition: and(succeeded(), or(eq('${{ parameters.targets }}', 'all'), eq('${{ parameters.targets }}', 'rust')))
    jobs:
      - job: PublishCrates
        displayName: 'Publish Rust crates'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - script: |
              curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
              echo "##vso[task.prependpath]$HOME/.cargo/bin"
            displayName: 'Install Rust'

          - script: |
              publish_crate() {
                local crate=$1
                echo "üì¶ Publishing $crate..."
                cd $crate
                if [ "${{ parameters.dryRun }}" = "True" ]; then
                  cargo publish --dry-run
                else
                  cargo publish --allow-dirty || echo "‚ö†Ô∏è $crate may already be published"
                  sleep 30
                fi
                cd ..
              }
              
              export CARGO_REGISTRY_TOKEN=$(CRATES_IO_TOKEN)
              
              publish_crate sochdb-core
              publish_crate sochdb-storage
              publish_crate sochdb-index
              publish_crate sochdb-query
              publish_crate sochdb-client  # Published as 'sochdb' on crates.io
            displayName: 'Publish crates in dependency order'
            env:
              CRATES_IO_TOKEN: $(CRATES_IO_TOKEN)

  # ===========================================================================
  # Stage 3: Build Python wheels
  # ===========================================================================
  - stage: BuildPython
    displayName: 'Build Python wheels'
    dependsOn: Validate
    condition: and(succeeded(), or(eq('${{ parameters.targets }}', 'all'), eq('${{ parameters.targets }}', 'python')))
    jobs:
      # Linux x86_64
      - job: BuildLinux
        displayName: 'Linux x86_64'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '3.12'

          - script: |
              curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
              echo "##vso[task.prependpath]$HOME/.cargo/bin"
            displayName: 'Install Rust'

          - script: cargo build --release -p sochdb-tools -p sochdb-storage -p sochdb-index
            displayName: 'Build Rust libraries'

          - script: |
              mkdir -p sochdb-python-sdk/src/sochdb/lib/x86_64-unknown-linux-gnu
              mkdir -p sochdb-python-sdk/src/sochdb/_bin/x86_64-unknown-linux-gnu
              cp target/release/libsochdb_storage.so sochdb-python-sdk/src/sochdb/lib/x86_64-unknown-linux-gnu/
              cp target/release/libsochdb_index.so sochdb-python-sdk/src/sochdb/lib/x86_64-unknown-linux-gnu/
              cp target/release/sochdb-bulk sochdb-python-sdk/src/sochdb/_bin/x86_64-unknown-linux-gnu/
              chmod +x sochdb-python-sdk/src/sochdb/_bin/x86_64-unknown-linux-gnu/sochdb-bulk
            displayName: 'Copy binaries to SDK'

          - script: |
              cd sochdb-python-sdk
              pip install build wheel
              python -m build
              cd dist
              for f in *-py3-none-any.whl; do
                newname=$(echo $f | sed 's/-py3-none-any/-py3-none-manylinux_2_17_x86_64/')
                mv "$f" "$newname"
              done
            displayName: 'Build wheel'

          - publish: sochdb-python-sdk/dist
            artifact: python-linux-x64

      # macOS ARM64
      - job: BuildMacOS
        displayName: 'macOS ARM64'
        pool:
          vmImage: 'macOS-latest'
        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '3.12'

          - script: |
              curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
              echo "##vso[task.prependpath]$HOME/.cargo/bin"
            displayName: 'Install Rust'

          - script: |
              rustup target add aarch64-apple-darwin
              cargo build --release -p sochdb-tools -p sochdb-storage -p sochdb-index --target aarch64-apple-darwin
            displayName: 'Build Rust libraries'

          - script: |
              mkdir -p sochdb-python-sdk/src/sochdb/lib/aarch64-apple-darwin
              mkdir -p sochdb-python-sdk/src/sochdb/_bin/aarch64-apple-darwin
              cp target/aarch64-apple-darwin/release/libsochdb_storage.dylib sochdb-python-sdk/src/sochdb/lib/aarch64-apple-darwin/
              cp target/aarch64-apple-darwin/release/libsochdb_index.dylib sochdb-python-sdk/src/sochdb/lib/aarch64-apple-darwin/
              cp target/aarch64-apple-darwin/release/sochdb-bulk sochdb-python-sdk/src/sochdb/_bin/aarch64-apple-darwin/
              chmod +x sochdb-python-sdk/src/sochdb/_bin/aarch64-apple-darwin/sochdb-bulk
            displayName: 'Copy binaries to SDK'

          - script: |
              cd sochdb-python-sdk
              pip install build wheel
              python -m build --wheel
              cd dist
              for f in *-py3-none-any.whl; do
                newname=$(echo $f | sed 's/-py3-none-any/-py3-none-macosx_11_0_arm64/')
                mv "$f" "$newname"
              done
            displayName: 'Build wheel'

          - publish: sochdb-python-sdk/dist
            artifact: python-macos-arm64

      # Windows x64
      - job: BuildWindows
        displayName: 'Windows x64'
        pool:
          vmImage: 'windows-latest'
        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '3.12'

          - script: |
              curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
            displayName: 'Install Rust'

          - script: cargo build --release -p sochdb-tools -p sochdb-storage -p sochdb-index
            displayName: 'Build Rust libraries'

          - powershell: |
              New-Item -ItemType Directory -Force -Path sochdb-python-sdk\src\sochdb\lib\x86_64-pc-windows-msvc
              New-Item -ItemType Directory -Force -Path sochdb-python-sdk\src\sochdb\_bin\x86_64-pc-windows-msvc
              Copy-Item target\release\sochdb_storage.dll sochdb-python-sdk\src\sochdb\lib\x86_64-pc-windows-msvc\
              Copy-Item target\release\sochdb_index.dll sochdb-python-sdk\src\sochdb\lib\x86_64-pc-windows-msvc\
              Copy-Item target\release\sochdb-bulk.exe sochdb-python-sdk\src\sochdb\_bin\x86_64-pc-windows-msvc\
            displayName: 'Copy binaries to SDK'

          - powershell: |
              cd sochdb-python-sdk
              pip install build wheel
              python -m build --wheel
              cd dist
              Get-ChildItem -Filter "*-py3-none-any.whl" | ForEach-Object {
                $newname = $_.Name -replace '-py3-none-any', '-py3-none-win_amd64'
                Rename-Item $_.FullName $newname
              }
            displayName: 'Build wheel'

          - publish: sochdb-python-sdk\dist
            artifact: python-windows-x64

  # ===========================================================================
  # Stage 4: Publish Python to PyPI
  # ===========================================================================
  - stage: PublishPython
    displayName: 'Publish to PyPI'
    dependsOn: BuildPython
    condition: and(succeeded(), or(eq('${{ parameters.targets }}', 'all'), eq('${{ parameters.targets }}', 'python')))
    jobs:
      - job: PublishPyPI
        displayName: 'Upload to PyPI'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '3.12'

          - download: current
            patterns: 'python-*/**'

          - script: |
              pip install twine
              mkdir -p wheels
              cp $(Pipeline.Workspace)/python-*/*.whl wheels/ || true
              cp $(Pipeline.Workspace)/python-*/*.tar.gz wheels/ || true
              echo "=== Packages to upload ==="
              ls -la wheels/
              twine check wheels/*
            displayName: 'Collect and validate packages'

          - script: |
              if [ "${{ parameters.dryRun }}" = "True" ]; then
                echo "üîç Dry run - skipping upload"
              else
                twine upload --skip-existing wheels/* \
                  --username __token__ \
                  --password $(PYPI_API_TOKEN)
              fi
            displayName: 'Upload to PyPI'
            env:
              PYPI_API_TOKEN: $(PYPI_API_TOKEN)

  # ===========================================================================
  # Stage 5: Publish npm
  # ===========================================================================
  - stage: PublishNpm
    displayName: 'Publish to npm'
    dependsOn: Validate
    condition: and(succeeded(), or(eq('${{ parameters.targets }}', 'all'), eq('${{ parameters.targets }}', 'npm')))
    jobs:
      - job: PublishNpmPackage
        displayName: 'Upload to npm'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '20.x'

          - script: |
              curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
              echo "##vso[task.prependpath]$HOME/.cargo/bin"
            displayName: 'Install Rust'

          - script: cargo build --release -p sochdb-tools
            displayName: 'Build sochdb-bulk binary'

          - script: |
              mkdir -p sochdb-js/_bin/x86_64-unknown-linux-gnu
              cp target/release/sochdb-bulk sochdb-js/_bin/x86_64-unknown-linux-gnu/
              chmod +x sochdb-js/_bin/x86_64-unknown-linux-gnu/sochdb-bulk
            displayName: 'Copy binary'

          - script: |
              cd sochdb-js
              npm ci
              npm run build
              npm test
            displayName: 'Build and test'

          - script: |
              cd sochdb-js
              echo "//registry.npmjs.org/:_authToken=$(NPM_TOKEN)" > .npmrc
              if [ "${{ parameters.dryRun }}" = "True" ]; then
                echo "üîç Dry run - validating package..."
                npm publish --dry-run --access public
              else
                npm publish --access public
              fi
            displayName: 'Publish to npm'
            env:
              NPM_TOKEN: $(NPM_TOKEN)

  # ===========================================================================
  # Stage 6: Publish Go Module
  # ===========================================================================
  - stage: PublishGo
    displayName: 'Publish Go Module'
    dependsOn: Validate
    condition: and(succeeded(), or(eq('${{ parameters.targets }}', 'all'), eq('${{ parameters.targets }}', 'go')))
    jobs:
      - job: PublishGoModule
        displayName: 'Tag Go module release'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            persistCredentials: true

          - task: GoTool@0
            inputs:
              version: '1.22'
            displayName: 'Set up Go'

          - script: |
              cd sochdb-go
              go mod download
              go build -v ./...
              go test -v ./...
            displayName: 'Test Go module'

          - script: |
              VERSION="v${{ parameters.version }}"
              TAG="sochdb-go/$VERSION"
              
              git config user.name "Azure Pipelines"
              git config user.email "azuredevops@microsoft.com"
              
              if git rev-parse "$TAG" >/dev/null 2>&1; then
                echo "Tag $TAG already exists, skipping..."
              elif [ "${{ parameters.dryRun }}" = "True" ]; then
                echo "üîç Dry run - would create tag: $TAG"
              else
                echo "Creating tag: $TAG"
                git tag -a "$TAG" -m "Release sochdb-go $VERSION"
                git push origin "$TAG"
                echo "Go module released: github.com/sochdb/sochdb-go@$VERSION"
              fi
            displayName: 'Create Go module tag'

  # ===========================================================================
  # Summary
  # ===========================================================================
  - stage: Summary
    displayName: 'Release Summary'
    dependsOn:
      - PublishRust
      - PublishPython
      - PublishNpm
      - PublishGo
    condition: always()
    jobs:
      - job: PrintSummary
        displayName: 'Print summary'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - script: |
              echo "========================================"
              echo "üöÄ SochDB Release v${{ parameters.version }}"
              echo "========================================"
              echo ""
              if [ "${{ parameters.dryRun }}" = "True" ]; then
                echo "Mode: Dry Run (no packages published)"
              else
                echo "Mode: Production Release"
              fi
              echo ""
              echo "Packages:"
              echo "  - crates.io: sochdb"
              echo "  - PyPI: sochdb-client"
              echo "  - npm: @sochdb/sochdb"
              echo "  - Go modules: github.com/sochdb/sochdb-go"
              echo ""
              echo "========================================"
            displayName: 'Release summary'
