# =============================================================================
# ToonDB Core Release Pipeline
# =============================================================================
#
# Builds Rust binaries and publishes to crates.io.
#
# SDK packages are maintained in separate repositories:
#   - Python SDK: https://github.com/toondb/toondb-python-sdk
#   - Node.js SDK: https://github.com/toondb/toondb-nodejs-sdk
#   - Go SDK: https://github.com/toondb/toondb-go
#
# Platforms supported:
#   - Linux x86_64 (manylinux)
#   - macOS ARM64 (Apple Silicon)
#   - macOS x86_64 (Intel)
#   - Windows x64
#
# =============================================================================
# REQUIRED SETUP:
# =============================================================================
# 
# 1. Create GitHub Environment "toondb-workflow":
#    Settings â†’ Environments â†’ New environment â†’ Name: "toondb-workflow"
#
# 2. Add Environment Secrets (in the toondb-workflow environment):
#    CRATES_IO_TOKEN   - crates.io API token (https://crates.io/settings/tokens)
#
# 3. GITHUB_TOKEN - NO ACTION NEEDED!
#    Automatically provided by GitHub Actions. Do NOT add as a secret.
#    Used for: Git operations, creating releases
# =============================================================================

name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 0.2.4)'
        required: true
        type: string
      dry_run:
        description: 'Dry run (validate without publishing)'
        required: false
        default: false
        type: boolean

concurrency:
  group: release-unified-${{ github.ref }}
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  RELEASE_VERSION: ${{ inputs.version }}

jobs:
  # ===========================================================================
  # Validate - Basic workspace validation (formatting/tests done locally)
  # ===========================================================================
  validate:
    name: Validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Workspace validation
        run: echo "âœ… Workspace validated (formatting and tests verified locally)"

  # ===========================================================================
  # Build Rust Binaries - Matrix for all platforms
  # ===========================================================================
  build-binaries:
    name: Build Binaries (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    needs: validate
    strategy:
      fail-fast: false  # Continue building other platforms if one fails
      matrix:
        include:
          # Linux x86_64
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            binary_ext: ""
            lib_ext: ".so"
            
          # macOS ARM64 (Apple Silicon) - Rosetta 2 handles x86 apps
          - os: macos-latest
            target: aarch64-apple-darwin
            binary_ext: ""
            lib_ext: ".dylib"
            
          # Windows x64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            binary_ext: ".exe"
            lib_ext: ".dll"

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          version: "25.x"
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release binaries
        shell: bash
        run: |
          # Build libraries first (needed by all platforms)
          cargo build --release --target ${{ matrix.target }} \
            -p toondb-storage \
            -p toondb-index
          
          # Build binaries (toondb-server is Unix-only)
          if [ "${{ matrix.target }}" = "x86_64-pc-windows-msvc" ]; then
            # Windows: skip toondb-server (uses Unix sockets)
            cargo build --release --target ${{ matrix.target }} \
              --bin toondb-bulk \
              --bin toondb-grpc-server \
              --bin toondb-mcp
          else
            # Unix: build all binaries
            cargo build --release --target ${{ matrix.target }} \
              -p toondb-tools \
              -p toondb-grpc \
              -p toondb-mcp
          fi

      - name: Create artifact directory
        shell: bash
        run: |
          mkdir -p artifacts/${{ matrix.target }}
          
          # Copy binaries and shared libraries
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            # Binaries (no toondb-server on Windows - uses Unix sockets)
            cp target/${{ matrix.target }}/release/toondb-bulk.exe artifacts/${{ matrix.target }}/
            cp target/${{ matrix.target }}/release/toondb-grpc-server.exe artifacts/${{ matrix.target }}/
            cp target/${{ matrix.target }}/release/toondb-mcp.exe artifacts/${{ matrix.target }}/
            # Shared libraries (DLLs)
            cp target/${{ matrix.target }}/release/toondb_storage.dll artifacts/${{ matrix.target }}/
            cp target/${{ matrix.target }}/release/toondb_index.dll artifacts/${{ matrix.target }}/
          else
            # Binaries (Unix: Linux + macOS)
            cp target/${{ matrix.target }}/release/toondb-bulk artifacts/${{ matrix.target }}/
            cp target/${{ matrix.target }}/release/toondb-server artifacts/${{ matrix.target }}/
            cp target/${{ matrix.target }}/release/toondb-grpc-server artifacts/${{ matrix.target }}/
            cp target/${{ matrix.target }}/release/toondb-mcp artifacts/${{ matrix.target }}/
            # Shared libraries (.so or .dylib)
            cp target/${{ matrix.target }}/release/libtoondb_storage${{ matrix.lib_ext }} artifacts/${{ matrix.target }}/
            cp target/${{ matrix.target }}/release/libtoondb_index${{ matrix.lib_ext }} artifacts/${{ matrix.target }}/
            chmod +x artifacts/${{ matrix.target }}/*
          fi

      - name: Upload binary artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ matrix.target }}
          path: artifacts/
          retention-days: 1

  # ===========================================================================
  # Publish Rust Crates
  # ===========================================================================
  publish-rust:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    needs: build-binaries
    environment:
      name: toondb-workflow
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          version: "25.x"
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-publish-${{ hashFiles('**/Cargo.lock') }}

      - name: Publish crates (dependency order)
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: |
          DRY_RUN="${{ inputs.dry_run }}"
          
          publish_crate() {
            local crate=$1
            echo "ðŸ“¦ Publishing $crate..."
            cd $crate
            if [ "$DRY_RUN" = "true" ]; then
              cargo publish --dry-run --allow-dirty
            else
              cargo publish --allow-dirty || echo "âš ï¸ $crate may already be published"
              sleep 30  # Wait for crates.io to index
            fi
            cd ..
          }
          
          # Publish in dependency order
          publish_crate toondb-core
          publish_crate toondb-storage
          publish_crate toondb-index
          publish_crate toondb-query
          publish_crate toondb-client  # Published as 'toondb' on crates.io
          publish_crate toondb-grpc    # gRPC server with temporal graph support
          publish_crate toondb-mcp     # MCP server binary crate

  # ===========================================================================
  # Create GitHub Release with all artifacts
  # ===========================================================================
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: publish-rust
    if: ${{ inputs.dry_run != true }}
    permissions:
      contents: write  # Required to create releases and upload assets
    steps:
      - uses: actions/checkout@v4

      - name: Download all binary artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: binaries-*
          path: release-binaries/
          merge-multiple: true

      - name: Create release archives
        run: |
          mkdir -p release-assets
          
          for target in x86_64-unknown-linux-gnu aarch64-apple-darwin x86_64-pc-windows-msvc; do
            if [ -d "release-binaries/$target" ]; then
              cd release-binaries
              if [ "$target" = "x86_64-pc-windows-msvc" ]; then
                zip -r "../release-assets/toondb-${{ inputs.version }}-$target.zip" "$target"
              else
                tar -czvf "../release-assets/toondb-${{ inputs.version }}-$target.tar.gz" "$target"
              fi
              cd ..
            fi
          done
          
          ls -la release-assets/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ inputs.version }}
          name: ToonDB v${{ inputs.version }}
          draft: false
          prerelease: false
          files: release-assets/*
          body: |
            ## ToonDB v${{ inputs.version }}
            
            ### Installation
            
            **Rust (crates.io)**
            ```bash
            cargo add toondb
            ```
            
            ### SDK Repositories
            
            Language SDKs are now maintained in separate repositories:
            
            - **Python**: https://github.com/toondb/toondb-python-sdk
            - **Node.js/TypeScript**: https://github.com/toondb/toondb-nodejs-sdk
            - **Go**: https://github.com/toondb/toondb-go
            
            ### Examples
            
            - **Python Examples**: https://github.com/toondb/toondb-python-examples
            - **Node.js Examples**: https://github.com/toondb/toondb-nodejs-examples
            - **Go Examples**: https://github.com/toondb/toondb-golang-examples
            
            ### Benchmarks
            
            See https://github.com/toondb/toondb-benchmarks for performance comparisons.
            
            ### Pre-built Binaries
            
            This release includes pre-built binaries for:
            - Linux x86_64
            - macOS ARM64 (Apple Silicon) - Intel Macs use Rosetta 2
            - Windows x64
            
            See [CHANGELOG.md](https://github.com/toondb/toondb/blob/main/CHANGELOG.md) for details.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================================================
  # Release Summary
  # ===========================================================================
  summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: publish-rust
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## ðŸš€ ToonDB Core Release v${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "**Mode:** Dry Run (no packages published)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Mode:** Production Release" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Packages" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Package | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| crates.io | \`toondb\` | ${{ needs.publish-rust.result }} |" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### SDK Repositories" >> $GITHUB_STEP_SUMMARY
          echo "Language SDKs are maintained separately:" >> $GITHUB_STEP_SUMMARY
          echo "- [Python SDK](https://github.com/toondb/toondb-python-sdk)" >> $GITHUB_STEP_SUMMARY
          echo "- [Node.js SDK](https://github.com/toondb/toondb-nodejs-sdk)" >> $GITHUB_STEP_SUMMARY
          echo "- [Go SDK](https://github.com/toondb/toondb-go)" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Platforms Built" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Linux x86_64" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… macOS ARM64 (Apple Silicon)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Windows x64" >> $GITHUB_STEP_SUMMARY